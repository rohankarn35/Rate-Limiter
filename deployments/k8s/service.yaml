apiVersion: v1
kind: Service
metadata:
  name: rate-limiter
spec:
  selector:
    app: rate-limiter
  ports:
    - name: http
      port: 80
      targetPort: 8080
    - name: grpc
      port: 9093
      targetPort: 9093
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rate-limiter-config
data:
  config.yaml: |
    server:
      address: ":8080"
      grpc_address: ":9093"
      read_timeout: 5s
      write_timeout: 10s
      idle_timeout: 60s
    metrics:
      enabled: true
      path: /metrics
    storage:
      driver: redis
      redis:
        address: "redis:6379"
        username: ""
        password: ""
        db: 0
    policies:
      - name: per-ip
        routes: ["/api/v1/*"]
        methods: ["GET", "POST"]
        identity:
          type: ip
        algorithm:
          type: token_bucket
          limit: 20
          burst: 20
          refill_rate: 5
          interval: 1s
      - name: api-key
        routes: ["/api/v1/premium/*"]
        methods: ["GET", "POST"]
        identity:
          type: header
          key: X-API-Key
          fallback: ip
        algorithm:
          type: sliding_window
          limit: 100
          window: 1m
